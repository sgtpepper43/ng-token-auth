"undefined"!=typeof module&&"undefined"!=typeof exports&&module.exports===exports&&(module.exports="ng-token-auth"),angular.module("ng-token-auth",["ipCookie"]).provider("$auth",function(){var t,e;return t={"default":{apiUrl:"/api",signOutUrl:"/auth/sign_out",emailSignInPath:"/auth/sign_in",emailRegistrationPath:"/auth",accountUpdatePath:"/auth",accountDeletePath:"/auth",confirmationSuccessUrl:function(){return window.location.href},passwordResetPath:"/auth/password",passwordUpdatePath:"/auth/password",passwordResetSuccessUrl:function(){return window.location.href},tokenValidationPath:"/auth/validate_token",proxyIf:function(){return!1},proxyUrl:"/proxy",validateOnPageLoad:!0,forceHardRedirect:!1,storage:"cookies",tokenFormat:{"access-token":"{{ token }}","token-type":"Bearer",client:"{{ clientId }}",expiry:"{{ expiry }}",uid:"{{ uid }}"},parseExpiry:function(t){return 1e3*parseInt(t.expiry,10)||null},handleLoginResponse:function(t){return t.data},handleAccountUpdateResponse:function(t){return t.data},handleTokenValidationResponse:function(t){return t.data},authProviderPaths:{github:"/auth/github",facebook:"/auth/facebook",google:"/auth/google_oauth2"}}},e="default",{configure:function(n){var r,i,s,a,o,u,c,h,d,f;if(c={localStorage:{persistData:function(t,e){return $window.localStorage.setItem(t,JSON.stringify(e))},retrieveData:function(t){return JSON.parse($window.localStorage.getItem(t))},deleteData:function(t){return $window.localStorage.removeItem(t)}},cookies:{persistData:function(t,e){return ipCookie(t,e,{path:"/"})},retrieveData:function(t){return ipCookie(t)},deleteData:function(t){return ipCookie.remove(t,{path:"/"})}}},n instanceof Array&&n.length){for(a=d=0,f=n.length;f>d;a=++d){r=n[a],u=null;for(o in r)h=r[o],u=o,0===a&&(e=u);i=angular.copy(t["default"]),s={},s[u]=angular.extend(i,r[u]),s[u].storage instanceof Object||(s[u].storage=c[s[u].storage]),angular.extend(t,s)}"default"!==e&&delete t["default"]}else{if(!(n instanceof Object))throw"Invalid argument: ng-token-auth config should be an Array or Object.";angular.extend(t["default"],n),t["default"].storage instanceof Object||(t["default"].storage=c[t["default"].storage])}return t},$get:["$http","$q","$location","ipCookie","$window","$timeout","$rootScope","$interpolate",function(){return function(n,r,i,s,a,o,u,c){return{header:null,dfd:null,user:{},mustResetPassword:!1,listener:null,initialize:function(){return this.initializeListeners(),this.addScopeMethods()},initializeListeners:function(){return this.listener=angular.bind(this,this.handlePostMessage),a.addEventListener?a.addEventListener("message",this.listener,!1):void 0},cancel:function(t){return null!=this.t&&o.cancel(this.t),null!=this.dfd&&this.rejectDfd(t),o(function(t){return function(){return t.t=null}}(this),0)},destroy:function(){return this.cancel(),a.removeEventListener?a.removeEventListener("message",this.listener,!1):void 0},handlePostMessage:function(t){var e;return"deliverCredentials"===t.data.message&&(delete t.data.message,this.handleValidAuth(t.data,!0),u.$broadcast("auth:login-success",t.data)),"authFailure"===t.data.message?(e={reason:"unauthorized",errors:[t.data.error]},this.cancel(e),u.$broadcast("auth:login-error",e)):void 0},addScopeMethods:function(){return u.user=this.user,u.authenticate=angular.bind(this,this.authenticate),u.signOut=angular.bind(this,this.signOut),u.destroyAccount=angular.bind(this,this.destroyAccount),u.submitRegistration=angular.bind(this,this.submitRegistration),u.submitLogin=angular.bind(this,this.submitLogin),u.requestPasswordReset=angular.bind(this,this.requestPasswordReset),u.updatePassword=angular.bind(this,this.updatePassword),u.updateAccount=angular.bind(this,this.updateAccount),this.getConfig().validateOnPageLoad?this.validateUser({config:this.getSavedConfig()}):void 0},submitRegistration:function(t,e){var r;return null==e&&(e={}),r=this.getResultOrValue(this.getConfig(e.config).confirmationSuccessUrl),angular.extend(t,{confirm_success_url:r,config_name:this.getCurrentConfigName(e.config)}),n.post(this.apiUrl(e.config)+this.getConfig(e.config).emailRegistrationPath,t).success(function(){return u.$broadcast("auth:registration-email-success",t)}).error(function(t){return u.$broadcast("auth:registration-email-error",t)})},submitLogin:function(t,e){return null==e&&(e={}),this.initDfd(),n.post(this.apiUrl(e.config)+this.getConfig(e.config).emailSignInPath,t).success(function(t){return function(n){var r;return t.setConfigName(e.config),r=t.getConfig(e.config).handleLoginResponse(n,t),t.handleValidAuth(r),u.$broadcast("auth:login-success",t.user)}}(this)).error(function(t){return function(e){return t.rejectDfd({reason:"unauthorized",errors:["Invalid credentials"]}),u.$broadcast("auth:login-error",e)}}(this)),this.dfd.promise},userIsAuthenticated:function(){var t;return t=r.defer(),r.when(this.retrieveData("auth_headers")).then(function(e){return this.tokenHasExipred().then(function(n){return t.resolve(e&&this.user.signedIn&&!n)})}),t.promise},requestPasswordReset:function(t,e){var r;return null==e&&(e={}),r=this.getResultOrValue(this.getConfig(e.config).passwordResetSuccessUrl),t.redirect_url=r,null!=e.config&&(t.config_name=e.config),n.post(this.apiUrl(e.config)+this.getConfig(e.config).passwordResetPath,t).success(function(){return u.$broadcast("auth:password-reset-request-success",t)}).error(function(t){return u.$broadcast("auth:password-reset-request-error",t)})},updatePassword:function(t){return n.put(this.apiUrl()+this.getConfig().passwordUpdatePath,t).success(function(t){return function(e){return u.$broadcast("auth:password-change-success",e),t.mustResetPassword=!1}}(this)).error(function(t){return u.$broadcast("auth:password-change-error",t)})},updateAccount:function(t){return n.put(this.apiUrl()+this.getConfig().accountUpdatePath,t).success(function(t){return function(e){var n;return n=t.getConfig().handleAccountUpdateResponse(e),r.when(t.retrieveData("auth_headers")).then(function(t){var r,i,s,a,o;if(r=t,angular.extend(this.user,n),r){s={},o=this.getConfig().tokenFormat;for(i in o)a=o[i],r[i]&&n[i]&&(s[i]=n[i]);this.setAuthHeaders(s)}return u.$broadcast("auth:account-update-success",e)})}}(this)).error(function(t){return u.$broadcast("auth:account-update-error",t)})},destroyAccount:function(t){return n["delete"](this.apiUrl()+this.getConfig().accountUpdatePath,t).success(function(t){return function(e){return t.invalidateTokens(),u.$broadcast("auth:account-destroy-success",e)}}(this)).error(function(t){return u.$broadcast("auth:account-destroy-error",t)})},authenticate:function(t,e){return null==e&&(e={}),null==this.dfd&&(this.setConfigName(e.config),this.initDfd(),this.openAuthWindow(t,e)),this.dfd.promise},setConfigName:function(t){return null==t&&(t=e),this.persistData("currentConfigName",t,t)},openAuthWindow:function(t,e){var n;return n=this.buildAuthUrl(t,e),this.useExternalWindow()?this.requestCredentials(this.createPopup(n)):this.visitUrl(n)},visitUrl:function(t){return a.location.replace(t)},buildAuthUrl:function(t,e){var n,r,i,s;if(null==e&&(e={}),n=this.getConfig(e.config).apiUrl,n+=this.getConfig(e.config).authProviderPaths[t],n+="?auth_origin_url="+encodeURIComponent(a.location.href),null!=e.params){s=e.params;for(r in s)i=s[r],n+="&",n+=encodeURIComponent(r),n+="=",n+=encodeURIComponent(i)}return n},requestCredentials:function(t){return t.closed?(this.cancel({reason:"unauthorized",errors:["User canceled login"]}),u.$broadcast("auth:window-closed")):(t.postMessage("requestCredentials","*"),this.t=o(function(e){return function(){return e.requestCredentials(t)}}(this),500))},createPopup:function(t){return a.open(t)},resolveDfd:function(){return this.dfd.resolve(this.user),o(function(t){return function(){return t.dfd=null,u.$$phase?void 0:u.$digest()}}(this),0)},validateUser:function(t){var e;return null==t&&(t={}),e=t.config,null==this.dfd&&(this.initDfd(),this.userIsAuthenticated().then(function(t){return t?this.resolveDfd():r.when(this.retrieveData("currentConfigName")).then(function(t){var n,s,a,o;return void 0!==i.search().token?(a=i.search().token,n=i.search().client_id,o=i.search().uid,s=i.search().expiry,e=i.search().config,this.setConfigName(e),this.mustResetPassword=i.search().reset_password,this.firstTimeLogin=i.search().account_confirmation_success,this.setAuthHeaders(this.buildAuthHeaders({token:a,clientId:n,uid:o,expiry:s})),i.url(i.path()||"/")):t&&(e=t),r.when(this.retrieveData("auth_headers")).then(function(t){return this.tokenHasExpired().then(function(n){return isEmpty(t)?(this.rejectDfd({reason:"unauthorized",errors:["No credentials"]}),u.$broadcast("auth:invalid")):n?(u.$broadcast("auth:session-expired"),this.rejectDfd({reason:"unauthorized",errors:["Session expired."]})):this.validateToken({config:e})})})})})),this.dfd.promise},validateToken:function(t){return null==t&&(t={}),this.tokenHasExpired().then(function(e){return e?this.rejectDfd({reason:"unauthorized",errors:["Expired credentials"]}):n.get(this.apiUrl(t.config)+this.getConfig(t.config).tokenValidationPath).success(function(e){return function(n){var r;return r=e.getConfig(t.config).handleTokenValidationResponse(n),e.handleValidAuth(r),e.firstTimeLogin&&u.$broadcast("auth:email-confirmation-success",e.user),e.mustResetPassword&&u.$broadcast("auth:password-reset-confirm-success",e.user),u.$broadcast("auth:validation-success",e.user)}}(this)).error(function(t){return function(e){return t.firstTimeLogin&&u.$broadcast("auth:email-confirmation-error",e),t.mustResetPassword&&u.$broadcast("auth:password-reset-confirm-error",e),u.$broadcast("auth:validation-error",e),t.rejectDfd({reason:"unauthorized",errors:e.errors})}}(this))})},tokenHasExpired:function(){var t;return t=r.defer(),this.getExpiry().then(function(e){var n;return n=(new Date).getTime(),t.resolve(e&&n>e)}),t.promise},getExpiry:function(){var t;return t=r.defer(),r.when(this.retrieveData("auth_headers")).then(function(e){return t.resolve(this.getConfig().parseExpiry(e||{}))}),t.promise},invalidateTokens:function(){var t,e,n;n=this.user;for(t in n)e=n[t],delete this.user[t];return this.deleteData("currentConfigName"),null!=this.timer&&o.cancel(this.timer),this.deleteData("auth_headers")},signOut:function(){return n["delete"](this.apiUrl()+this.getConfig().signOutUrl).success(function(t){return function(){return t.invalidateTokens(),u.$broadcast("auth:logout-success")}}(this)).error(function(t){return function(e){return t.invalidateTokens(),u.$broadcast("auth:logout-error",e)}}(this))},handleValidAuth:function(t,e){return null==e&&(e=!1),null!=this.t&&o.cancel(this.t),angular.extend(this.user,t),this.user.signedIn=!0,this.user.configName=this.getCurrentConfigName(),e&&this.setAuthHeaders(this.buildAuthHeaders({token:this.user.auth_token,clientId:this.user.client_id,uid:this.user.uid,expiry:this.user.expiry})),this.resolveDfd()},buildAuthHeaders:function(t){var e,n,r,i;e={},i=this.getConfig().tokenFormat;for(n in i)r=i[n],e[n]=c(r)(t);return e},persistData:function(t,e,n){return this.getConfig(n).storage.persistData(t,e)},retrieveData:function(t){return this.getConfig().storage.retrieveData(t)},deleteData:function(t){return this.getConfig().storage.deleteData(t)},setAuthHeaders:function(t){return r.when(this.retrieveData("auth_headers")).then(function(e){var n;return n=angular.extend(e||{},t),r.when(this.persistData("auth_headers",n)).then(function(){return this.getExpiry().then(function(t){var e;return e=(new Date).getTime(),t>e?(null!=this.timer&&o.cancel(this.timer),this.timer=o(function(t){return function(){return t.validateUser({config:t.getSavedConfig()})}}(this),parseInt((t-e)/1e3))):void 0})})})},useExternalWindow:function(){return!(this.getConfig().forceHardRedirect||a.isIE())},initDfd:function(){return this.dfd=r.defer()},rejectDfd:function(t){return this.invalidateTokens(),null!=this.dfd?(this.dfd.reject(t),o(function(t){return function(){return t.dfd=null}}(this),0)):void 0},apiUrl:function(t){return this.getConfig(t).proxyIf()?this.getConfig(t).proxyUrl:this.getConfig(t).apiUrl},getConfig:function(e){return t[this.getCurrentConfigName(e)]},getResultOrValue:function(t){return"function"==typeof t?t():t},getCurrentConfigName:function(t){return t||this.getSavedConfig()},getSavedConfig:function(){var t,n;return t=void 0,n="currentConfigName",a.localStorage&&null==t&&(t=JSON.parse(a.localStorage.getItem(n))),null==t&&(t=s(n)),t||e}}}}(this)]}}).config(["$httpProvider",function(t){var e,n,r;return n=function(t,e){var n;return n=$q.defer(),t.getExpiry().then(function(r){var i,s;return s=Number(r),i=Number(t.getConfig().parseExpiry(e||{})),n.resolve(i>=s)}),n.promise},r=function(t,e){var r,i,s,a;i={},a=t.getConfig().tokenFormat;for(r in a)s=a[r],e.headers(r)&&(i[r]=e.headers(r));return n(t,i).then(function(e){return e?t.setAuthHeaders(i):void 0})},t.interceptors.push(["$injector",function(t){return{request:function(e){var n;return n=$q.defer(),t.invoke(["$http","$auth",function(t,r){return e.url.match(r.apiUrl())?$q.when(r.retrieveData("auth_headers")).then(function(t){var r,i;for(r in t)i=t[r],e.headers[r]=i;return n.resolve(e)}):void 0}]),n.promise},response:function(e){return t.invoke(["$http","$auth",function(t,n){return e.config.url.match(n.apiUrl())?r(n,e):void 0}]),e},responseError:function(e){return t.invoke(["$http","$auth",function(t,n){return e.config.url.match(n.apiUrl())?r(n,e):void 0}]),t.get("$q").reject(e)}}}]),e=["get","post","put","patch","delete"],angular.forEach(e,function(e){var n;return null==(n=t.defaults.headers)[e]&&(n[e]={}),t.defaults.headers[e]["If-Modified-Since"]="Mon, 26 Jul 1997 05:00:00 GMT"})}]).run(["$auth","$window","$rootScope",function(t){return t.initialize()}]),window.isOldIE=function(){var t,e,n;return e=!1,t=navigator.userAgent.toLowerCase(),t&&-1!==t.indexOf("msie")&&(n=parseInt(t.split("msie")[1]),10>n&&(e=!0)),e},window.isIE=function(){var t;return t=navigator.userAgent.toLowerCase(),t&&-1!==t.indexOf("msie")||!!navigator.userAgent.match(/Trident.*rv\:11\./)},window.isEmpty=function(t){var e,n;if(!t)return!0;if(t.length>0)return!1;if(0===t.length)return!0;for(e in t)if(n=t[e],Object.prototype.hasOwnProperty.call(t,e))return!1;return!0};